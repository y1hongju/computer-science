# ch3.네트워크 계층

## 네트워크 계층

- 물리 계층과 데이터 링크 계층 → LAN에 국한된 통신
- LAN을 넘어서기 위한 계층
- 네트워크 간 통신이 가능한 계층 → 라우팅(패킷을 목적지까지 최적의 경로로 찾아가는 과정)
- 단편화가 이루어지는 계층



# IP (논리적 주소)

vs 데이터링크 계층의 MAC주소 : 물리적 주소

- MAC주소만으로 도달 경로를 파악하기 어려움(라우팅 어려움)
- 임의의 네트워크에 속한 호스트의 MAC 주소를 기억하기 어려움

→ MAC주소와 IP주소를 동시에, IP주소를 더 우선적으로 활용하여 통신함

MAC주소는 발신인,수신인  

IP주소는 발신주소,수신주소로 비유할 수 있음

- 직접할당과 자동할당(DHCP)

### IP의 두가지 주요 기능

- IP 주소 지정
- 단편화

### 단편화

- 패킷의 크기를 MTU(Maximum Transmission Unit) 이하로 유지
- MTU 크기 이하로 단편화된 패킷들은 목적지에서 재조합
- MTU 크기에 따라 성능에 영향이 있음

### IPv4 헤더

- 송신지, 목적지 IP 주소 (192.18.100.12)
- 식별자 : 패킷에 할당된 번호 (재조합시 사용)
- 플래그 : 부가 정보 (3비트 구성 : 미사용(항상 0), Don’t Fragment, More Fragement 비트)
- 단편화 오프셋 : 단편화되기 전 데이터가 얼마나 떨어져 있는가
- TTL(Time To Live, 패킷의 수명, 라우터를 거칠 때마다 1 감소) , 프로토콜

### **IPv4 주소**

- 4바이트(32비트)로 표현 가능 , 점을 기준으로 4개의 숫자로 표현
- 한 옥텟은 0~255 범위의 네 개의 십진수로 표기
- 이론적으로 할당 가능한 IPv4 주소 개수 == 2^32개
    - 그러나 넉넉한 양이 아니다, IP 주소 부족 문제 발생

### **IPv6 주소**

- 16바이트 (128비트)로 표현 가능
- 이로ㅓㄴ적으로 할당 가능한 IPv6 주소 개수 == 2^128개 ← 사실상 무한

### **IPv6 헤더**

- 더 단순한 구조



# ARP

ARP는 IP주소를 통해 MAC 주소를 알아내기 위한 프로토콜

동일 네트워크 내의 호스트의 MAC 주소를 알아내기 위한 프로토콜

### ARP 동작 과정

1.ARP 요청

2.ARP 응답

3.ARP 테이블(ARP 캐시) 갱신

→ IP주소와 MAC주소 획득

ARP 패킷을 주고 받음

### 1. ARP 요청 (브로드캐스트 메세지)

특정 IP 주소를 가진 호스트의 MAC 주소를 알아내기 위해 보내는 브로드 캐스트 메세지

해당 호스트의 MAC 주소를 모르기 때문에 브로드캐스트 메세지로 전송

→ 허공에 대고 소리치는것과 같다. 

### 2. ARP 응답

ARP 요청 메세지에 대한 응답. 자신의 MAC 주소 포함.

### 3. ARP 테이블 갱신

- ARP 테이블 (ARP 캐시): MAC 주소와 IP주소가 매핑된 표 형태의 데이터
- 일정 시간이 지나면 삭제
- ARP 테이블에 추가된 호스트는 브로드 캐스트로 ARP 요청 보낼 필요 없음

cf) arp -a 명령어

cf) ARP가 닿는 범위를 LAN의 근거리 네트워크 범위라고 보는 관점도 있다.



# ICMP

### IP의 한계

- 비신뢰성 : 패킷이 목적지까지 제대로 전송된다는 보장이 없는 특성 , 최선형전달(best-effort delivery)라고도 부름
- 비연결형 : 호스트 간의 사전 연결 수립이 없는 특성

신뢰성 프로토콜, 연결형 프로토콜을 제공하는 계층은 전송계층 (TCP)

전송계층을 이용하면 IP의 한계를 극복할 수 있다.

### ICMP

IP의 비신뢰성과 비연결형 특성을 보완하기 위한 네트워크 계층의 프로토콜

IP 패킷의 전송 과정에 대한 피드백 메세지 제공

- 오류 보고
- 네트워크 진단 정보
    - 오류 보고
    - 네트워크 진단 정보

ICMP 메세지는 타입과 코드로 정의 (에코 요청, 에코 응답)

cf) traceroute google.com



# IP 주소

IP 주소의 구성: 네트워크 주소, 호스트 주소 (유동적)

172.16.12.45  ( e.g.; 앞 두 옥텟이 네트워크 주소, 뒤 두 옥텟이 호스트주소)

MAC 주소의 구성도 마찬가지 : 제조사 번호, 일련 번호

그러나 네트워크 주소의 크기와 호스트 주소의 크기는 변동성이 있음

### 클래스풀 주소체계

A클래스, B클래스, C클래스 + (D,E클래스 : 예약된 주소)

- 호스트 주소부가 전부 0인 경우 : 네트워크 주소를 나타냄
- 호스트 주소부가 전부 1인 경우 : 브로드캐스트를 나타냄

### 클래스리스 주소쳬계

- 클래스풀 주소 체계보다 더 정교히 네트워크를 나누는 방법
- 오늘날 주로 사용하는 방식
- 네트워크와 호스트를 구분하기 위해 **서브넷 마스크** 이용

### 서브넷 마스크

- IP 주소 상에서 네트워크 주소는 1, 호스트 주소는 0으로 이루어진 비트열

→ 서브넷 마스크와 IP주소의 비트 AND 연산 : 네트워크 주소

### CIDR 표기

- 서브넷 마스크 상의 1의 개수를 IP주소/숫자 로 표기
- 192.168.100.103/30
    - IP Address , Network Address, Usable Host IP Range, Braodcast Address , Total  Number of Hosts, Number of Usable Hosts, Subnet Mask 파악 가능해야함



# IP 주소의 분류

**공인 IP 주소와 사설 IP 주소**

IP 주소는 고유한가?

- 공인 IP 주소: 인터넷 사용할 때 사용하는 고유한 주소
- 사설 IP 주소 : 사설 네트워크 내에서 사용하는 고유하지 않은 주소

바깥세상 (인터넷)에서 사용되는 IP만 고유하면된다. LAN내에서는 사설IP 상관없음

**예약된 IP 주소**

사설 IP주소로서, 중복이 될 수 있음

**NAT** 

공인 IP 주소와 사설 IP 주소 간의 변환 기능

cf) 공유기 : 여러 네트워크 장비의 기능이 포함된 네트워크 장비 종합 셋트 : 라우터, NAT기능, DHCP서버 기능

- 하나의 공인 IP 주소를 여러 사설 IP 주소가 공유 가능
- IP 주소 부족 문제 해결   (with 포트)

**정적 IP 주소와 동적 IP 주소**

- IP 주소의 할당 방법: **정적 할당**과 **동적 할당**
- 정적 IP 주소 : 정적 할당된 IP 주소 (고정)
- 동적 IP 주소 : 동적 할당된 IP 주소 (유동적)

cf) 기본 게이트웨이

**DHCP**

- 동적 IP 주소를 할당하기 위한 프로토콜
- DHCP 서버에 동적으로 IP 주소 할당 (==IP 주소 임대)
- 정해진 임대 시간이 끝날 경우 임대 갱신 (자동 수행, 수동 수행)



# 라우팅

네트워크 계층 장비, 라우터

- 라우팅 : 패킷이 이동할 최적 경로 설정, 해당 경로로 패킷 이동
- 라우팅 프로토콜: 라우팅을 수행하는 방법
- 홉 : 일반적으로 라우터와 라우터 간의 패킷 이동 과정 (호스트간의 호스트간의 패킷 이동 포함)
- 홉 바이 홉 라우팅

라우팅 테이블(routing table)

라우터는 어떻게 패킷을 최종 목적지까지 보낼 수 있을까?

- 특정 목적지까지 도달하기 위한 정보를 명시하는 표와 같은 정보
- 대표적인 정보: 목적지 주소, 서브넷 마스크, 게이트웨이, 인터페이스, 메트릭
- 매트릭(비용)

- 롱기스트 프리픽스 매치(longest prefix match)
    - 엔트리를 선택하는 방법
    - 여러 라우팅 테이블 항목과 일치할 경우 가장 길게 일치하는 항목 선택 후 패킷 전송

- 디폴트 라우트 (default rounte)
    - 합치되는 경로가 없을 경우 기본으로 내보낼 경로 (0.0.0.0 /0)

라우팅 테이블이 만들어지는 방법

- 정적 라우팅 : 수동으로 라우팅 테이블 항목 채워넣기
- 동적 라우팅 : 자동으로 라우팅 테이블 항목 채워넣기 (라우팅 프로토콜)
    - 경로 우회 가능

라우팅 프로토콜

- AS 내부 라우팅 프로토콜(IGP) : RIP, OSPF
- AS 외부 라우팅 프로토콜(EGP): BGP
- AS == 동일한 라우팅 정책으로 운영되는 **라우터들의 집단** 네트워크